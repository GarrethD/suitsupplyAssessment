name: Run Postman Tests

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v2

      - name: Set up Node.js
        uses: actions/setup-node@v2
        with:
          node-version: '16'

      - name: Install Newman
        run: npm install -g newman

      - name: Run Postman Tests
        run: |
          newman run RegresAPITests.postman_collection.json -e RegressEnvironment.postman_environment.json -d userdata.csv --reporters cli,junit --reporter-junit-export results.xml
          
      - name: Print Summary
        uses: actions/github-script@v6
        with:
           script: |
      const fs = require('fs');
      const summary = JSON.parse(fs.readFileSync('summary.json', 'utf8'));
      const table = `\n\n
      ┌─────────────────────────┬────────────────────┬────────────────────┐
      │                         │           executed │             failed │
      ├─────────────────────────┼────────────────────┼────────────────────┤
      │              iterations │                  ${summary.run.stats.iterations.total} │                  ${summary.run.stats.iterations.failed} │
      ├─────────────────────────┼────────────────────┼────────────────────┤
      │                requests │                 ${summary.run.stats.requests.total} │                  ${summary.run.stats.requests.failed} │
      ├─────────────────────────┼────────────────────┼────────────────────┤
      │            test-scripts │                 ${summary.run.stats.tests.total} │                  ${summary.run.stats.tests.failed} │
      ├─────────────────────────┼────────────────────┼────────────────────┤
      │      prerequest-scripts │                  ${summary.run.stats.prerequests.total} │                  ${summary.run.stats.prerequests.failed} │
      ├─────────────────────────┼────────────────────┼────────────────────┤
      │              assertions │                 ${summary.run.stats.assertions.total} │                  ${summary.run.stats.assertions.failed} │
      ├─────────────────────────┴────────────────────┴────────────────────┤
      │ total run duration: ${summary.run.timings.completed - summary.run.timings.started}ms                      │
      ├───────────────────────────────────────────────────────────────────┤
      │ total data received: ${summary.run.transfers.responseTotal}kB (approx)                           │
      ├───────────────────────────────────────────────────────────────────┤
      │ average response time: ${summary.run.timings.responseAverage}ms [min: ${summary.run.timings.responseMin}ms, max: ${summary.run.timings.responseMax}ms, s.d.: ${summary.run.timings.responseStandardDeviation}ms] │
      └───────────────────────────────────────────────────────────────────┘\n\n`;

      github.summary.addRaw(table);
      github.summary.write();